지금까지 만든 테스트 코드에서 `@Before` 메서드가 테스트 메서드 개수만큼 반복되기 때문에 어플리케이션 컨텍스트가 세 번 만들어진다. 만약 빈이 많아지고 복잡해지면 어플리케이션 컨텍스트 생성이 오래 걸릴 수 있다. 어떤 빈은 오브젝트가 생성될 때 자체적인 초기화 작업을 진행하는 경우도 있고, 독자적으로 많은 리소스를 할당하거나 독립적인 스레드를 띄우는 경우도 있다. 이런 경우에는 테스트를 마칠 때마다 어플리케이션 컨텍스트 내의 빈이 할당한 리소스 등을 정리해주지 않으면 문제가 생길 수 있다.

테스트는 가능한 한 독립적으로 매번 새로운 오브젝트를 만들어서 사용하는 것이 원칙이지만, 어플리케이션 컨텍스트처럼 생성에 많은 시간과 자원이 드는 경우에는 테스트 전체가 공유하는 오브젝트를 만들기도 한다. 어플리케이션 컨텍스트는 초기화되고 나면 내부의 상태가 바뀌는 일은 거의 없기 때문에 테스트의 실행 결과에 영향을 미칠 가능성은 낮다. 

JUnit이 매번 테스트 클래스의 오브젝트를 새로 만들기 때문에 어플리케이션 컨텍스트를 다른 곳이 저장해야 한다. JUnit이 지원하는 `@BeforeClass` 정적 메서드를 사용해서 정적 변수에 저장해두고 사용하는 방법이 있지만, 이것보다는 **Spring**이 직접 제공하는 어플리케이션 컨텍스트 테스트 지원 기능을 사용하는 것이 더 좋다. 
##### 2.4.1 테스트를 위한 어플리케이션 컨텍스트 관리
**Spring**은 JUnit을 이용하는 테스트 컨텍스트 프레임워크를 제공한다. 간단한 어노테이션 설정으로 테스트에서 필요로 하는 어플리케이션 컨텍스트를 만들어서 모든 테스트가 공유하게 할 수 있다.
###### 스프링 테스트 컨텍스트 프레임워크 적용
먼저 `@Before` 메서드에서 어플리케이션 컨텍스트를 생성하는 코드를 제거하고, 다음과 같이 코드를 작성해보자.
```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(location = "/applicationContext.xml")
public class UserDaoTest {
	@Autowired
	private ApplicationContext context;
	...

	@Before
	public void setUp() { // 어플리케이션 컨텍스트 생성 코드가 제거됨
		this.dao = this.context.getBean("userDao", UserDao.class);
		...
	}
}
```

위의 코드를 보면 `context`를 초기화해주는 코드가 없지만 테스트는 제대로 실행된다. `@RunWith`에 지정된 `SpringJUnit4ClassRunner` 클래스는 JUnit용 테스트 컨텍스트 프레임워크 확장 클래스다. 이것은 JUnit이 테스트를진행하는 중에 테스트가 사용할 어플리케이션 컨텍스트를 만들과 관리하는 작업을 진행해준다.

`@ContextConfiguration`은 자동으로 만들어줄 어플리케이션 컨텍스트의 설정파일 위치를 지정한 것이다.
###### 테스트 메서드의 컨텍스트 공유
**Spring**의 JUnit 확장기능은 테스트가 실행되기 전에 한 번만 어플리케이션 컨텍스트를 만들어두고, 테스트 오브젝트가 만들어질 때마다 어플리케이션 컨텍스트를 테스트 오브젝트의 특정 필드에 주입해준다. 일종의 DI라고 볼 수 있는데, 어플리케이션 오브젝트 사이의 관계를 관리하기 위한 DI와는 성격이 조금 다르다.

어플리케이션 컨텍스트를 한 번만 만들어서 공유하기 때문에 테스트 수행 속도는 매우 빨라진다. 첫 번째 테스트가 실행될 때 최초로 어플리케이션 컨텍스트가 만들어질 때 가장 오랜 시간이 걸리고 그 이후의 테스트는 실행 시간이 짧아진다.
###### 테스트 클래스의 컨텍스트 공유
여러 개의 테스트 클래스가 모두 같은 설정파일을 가진 어플리케이션 컨텍스트를 사용한다면, 테스트 클래스 사이에서도 어플리케이션 컨텍스트를 공유해서 사용할 수 있다. 다음과 같이 두 개의 테스트 클래스가 같은 설정파일을 사용하는 경우에는 테스트 수행 중에 하나의 어플리케이션 컨텍스트만 만들어진다.
```java
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "/applicationContext.xml")
public class UserDaoTest { ... }

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations = "/applicationContext.xml")
public class GroupDaoTest { ... }
```

**Spring**은 설정파일의 종류만큼 어플리케이션 컨텍스트를 만들고, 같은 설정파일을 지정한 테스트에서는 이것을 공유하게 해준다.
###### `@Autowired`
`@Autowired`를 이용한 DI 방법에 대해서는 나중에 자세히 살펴보도록 하고, 일단은 `@Autowired`가 붙은 인스턴스 변수가 있으면, 테스트 컨텍스트 프레임워크는 변수 타입과 일치하는 컨텍스트 내의 빈을 찾는다. 타입이 일치하는 빈이 있으면 인스턴스 변수에 주입해준다.

#TobySpring #Spring 